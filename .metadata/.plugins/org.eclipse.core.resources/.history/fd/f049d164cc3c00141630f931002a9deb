package by.pvt.epam.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import static by.pvt.epam.test.Test.logger;
import com.epam.project.database.connection.PoolSingleton;
import com.epam.project.database.dao.util.StatementCloseUtil;
import com.epam.project.entity.users.Admin;
import com.epam.project.entity.users.Student;
import com.epam.project.entity.users.Tutor;
import com.epam.project.exceptions.LogicException;
import com.epam.project.exceptions.TechnicalException;

import by.pvt.epam.entity.User;
import by.pvt.epam.pool.ConnectionPool;

public class UserDAOImpl extends UserDAO {

	private static final String SQL_QUERY_GET_USER = "SELECT login, name, surname, role_id FROM user WHERE login = ( SELECT login FROM user WHERE (login = ?) AND (password = ?))";

	public User getUser(String login, String password) {
		ConnectionPool pool = null;
		Connection connection = null;
		PreparedStatement preparedStatement = null;
		User user = null;
		try {
			pool = ConnectionPool.getInstance();
			connection = pool.getConnection();
			preparedStatement = connection.prepareStatement(SQL_QUERY_GET_USER);
			preparedStatement.setString(1, login);
			preparedStatement.setString(2, password);
			preparedStatement.executeQuery();
			ResultSet rs = preparedStatement.executeQuery();
			rs.next();
			user = initUser(user, rs);
		} catch (SQLException e) {
			logger.error("SQLException", e);
		} finally {
			pool.backConnection(connection);
			UserDAO.close(preparedStatement);
		}
		return user;
	}

	private User initUser(User user, ResultSet rs) throws LogicException,
			SQLException {
		String login = rs.getString(1);
		String name = rs.getString(2);
		String surname = rs.getString(3);
		int role = rs.getInt(4);
		
		case 1:
			user = new Admin(firstName, lastName, peopleId);
			((Admin) user).setPhone(other);
		
		return user;
	}
}
