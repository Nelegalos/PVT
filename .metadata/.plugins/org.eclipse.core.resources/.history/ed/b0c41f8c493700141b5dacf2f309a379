package by.pvt.resource.pool;

import java.util.Queue;
import java.util.concurrent.Semaphore;
import java.util.concurrent.TimeUnit;
import java.util.LinkedList;

import by.pvt.resource.exception.OperatorTechnicalException;

public class CallCenter<T> {
	private final static int NUMBER_OF_OPERATORS = 5;
	private final Semaphore semaphore = new Semaphore(NUMBER_OF_OPERATORS, true);

	private final Queue<Operator> operators = new LinkedList<Operator>();

	public CallCenter(Queue<Operator> source) {
		operators.addAll(source);
	}

	public Operator getOperator(long maxWaitMilSec)
			throws OperatorTechnicalException {

		try {

			while (!semaphore.tryAcquire(maxWaitMilSec, TimeUnit.MILLISECONDS)) {
				Thread.sleep(500);
			}

			if (semaphore.tryAcquire(maxWaitMilSec, TimeUnit.MILLISECONDS)) {
				Operator operator = operators.poll();
				return operator;
			}
		} catch (InterruptedException e) {
			throw new OperatorTechnicalException(e);
		}
		throw new OperatorTechnicalException(
				"All operators are busy at the moment");
	}

	public void releaseOperator(Operator operator) {
		operators.add(operator);
		semaphore.release();
	}
}